<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CSP: Allow style/script from extension and connect to local backend -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src ${webview.cspSource} 'unsafe-inline'; script-src ${webview.cspSource} 'unsafe-eval' https://unpkg.com; connect-src 'self' http://127.0.0.1:*;">
    <link href="${stylesUri}" rel="stylesheet">
    <!-- Vue 3 CDN (In production, you might bundle this) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <title>Gemini Swarm Mission Control</title>
</head>
<body>
    <div id="app">
        <!-- 1. HUD Header: System Status & Costs -->
        <header class="hud-header">
            <div class="status-group">
                <div class="status-item" :class="{ active: serverPort }">
                    <span class="status-dot"></span>
                    <span class="status-label">ENGINE: {{ serverPort || 'OFF' }}</span>
                </div>
                <div class="status-item" :class="{ active: isSandboxActive }">
                    <span class="icon">üì¶</span>
                    <span class="status-label">{{ isSandboxActive ? 'DOCKER' : 'MOCK' }}</span>
                </div>
            </div>
            
            <div class="cost-group" v-if="costStats.totalTokens > 0">
                <span class="cost-value">${{ costStats.totalCost.toFixed(4) }}</span>
                <span class="cost-label">USD</span>
            </div>
        </header>

        <!-- 2. Main Timeline: Chat & Artifacts -->
        <main id="chat-container" ref="chatContainer">
            <div v-if="messages.length === 0" class="welcome-screen">
                <div class="logo">üê±</div>
                <h2>Gemini Swarm</h2>
                <p>Coding Crew is ready, Master.</p>
                <div class="capabilities">
                    <span>üß† LangGraph Brain</span>
                    <span>üõ°Ô∏è Docker Sandbox</span>
                    <span>üëÅÔ∏è Repo Map Context</span>
                </div>
            </div>

            <div v-for="(msg, idx) in messages" :key="idx" :class="['message-row', msg.role]">
                
                <!-- Avatar -->
                <div class="avatar" :title="msg.role">
                    <span v-if="msg.role === 'user'">üë§</span>
                    <span v-else-if="msg.role === 'ai'">ü§ñ</span>
                    <span v-else>‚öôÔ∏è</span>
                </div>

                <!-- Message Content -->
                <div class="message-content">
                    
                    <!-- Text Message -->
                    <div v-if="msg.type !== 'code' && msg.type !== 'tool_proposal' && msg.type !== 'image'" class="bubble">
                        <div v-if="msg.role === 'system'" class="system-prefix">[SYSTEM]</div>
                        {{ msg.content }}
                    </div>

                    <!-- üñºÔ∏è Image Artifact (Matplotlib/Sandbox) -->
                    <div v-else-if="msg.type === 'image'" class="artifact-card image-card">
                        <div class="artifact-header">
                            <span>üìä Generated Image</span>
                            <span class="filename">{{ msg.label }}</span>
                        </div>
                        <div class="image-wrapper">
                            <img :src="msg.content" alt="Generated Plot" />
                        </div>
                    </div>

                    <!-- üíª Code Artifact -->
                    <div v-else-if="msg.type === 'code'" class="artifact-card code-card">
                        <div class="artifact-header">
                            <span>üìù Generated Code</span>
                            <div class="actions">
                                <button class="icon-btn" @click="insertCode(msg.content)" title="Insert at Cursor">üì• Insert</button>
                            </div>
                        </div>
                        <pre class="code-preview"><code>{{ msg.content }}</code></pre>
                    </div>

                    <!-- üõ†Ô∏è Tool Proposal (The Hands) -->
                    <div v-else-if="msg.type === 'tool_proposal'" class="artifact-card tool-card" :class="{ approved: msg.approved, rejected: msg.rejected }">
                        <div class="tool-header">
                            <span class="tool-icon" v-if="msg.content.tool === 'write_to_file'">üíæ</span>
                            <span class="tool-icon" v-else>‚ö°</span>
                            <span class="tool-name">{{ msg.label }}</span>
                        </div>
                        
                        <div class="tool-body">
                            <!-- Write File Details -->
                            <div v-if="msg.content.tool === 'write_to_file'">
                                <div class="param-row">
                                    <span class="label">PATH:</span>
                                    <span class="value path">{{ msg.content.params.path }}</span>
                                </div>
                                <div class="diff-preview-hint">
                                    Click "View Diff" to inspect changes before approving.
                                </div>
                            </div>
                            
                            <!-- Execute Command Details -->
                            <div v-else-if="msg.content.tool === 'execute_command'">
                                <div class="param-row">
                                    <span class="label">CMD:</span>
                                    <code class="value command">{{ msg.content.params.command }}</code>
                                </div>
                            </div>
                        </div>

                        <!-- Action Bar -->
                        <div class="tool-actions" v-if="!msg.approved && !msg.rejected">
                            <button v-if="msg.content.tool === 'write_to_file'" class="btn secondary" @click="viewDiff(msg.content)">
                                üëÅÔ∏è View Diff
                            </button>
                            <div class="approval-group">
                                <button class="btn reject" @click="rejectTool(idx)">üö´ Reject</button>
                                <button class="btn approve" @click="approveTool(idx, msg.content)">‚úÖ Approve</button>
                            </div>
                        </div>

                        <!-- Status Stamp -->
                        <div class="status-stamp approved" v-if="msg.approved">APPROVED</div>
                        <div class="status-stamp rejected" v-if="msg.rejected">REJECTED</div>
                    </div>

                </div>
            </div>

            <!-- Thinking Indicator -->
            <div v-if="isProcessing" class="thinking-row">
                <div class="spinner"></div>
                <span>Coding Crew is working...</span>
            </div>
        </main>

        <!-- 3. Input Deck -->
        <footer class="input-deck">
            <div class="toolbar">
                <button class="tool-btn" @click="runTest" title="Run Terminal Test">üíª</button>
                <span class="spacer"></span>
                <span class="token-counter" v-if="costStats.totalTokens">{{ formatNumber(costStats.totalTokens) }} toks</span>
            </div>
            <div class="input-wrapper">
                <textarea 
                    v-model="userInput" 
                    @keydown.enter.prevent="startTask" 
                    placeholder="Describe your task (e.g., 'Refactor this class', 'Create a snake game')..." 
                    rows="1"
                    ref="inputBox"
                ></textarea>
                <button class="send-btn" @click="startTask" :disabled="isProcessing || !userInput">
                    üöÄ
                </button>
            </div>
        </footer>
    </div>
    <script src="${scriptUri}"></script>
</body>
</html>
